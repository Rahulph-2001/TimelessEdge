<%- include("../../views/partials/user/header") %>
<style>
    /* Main Layout */
    .main {
        background-color: #f7f8fc;
        min-height: 100vh;
    }

    /* Breadcrumb Styles */
    .breadcrumb-wrap {
        padding: 20px 0;
        background-color: #fff;
        border-bottom: 1px solid #eee;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .breadcrumb a {
        color: #253D4E;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb a:hover {
        color: #3BB77E;
    }

    .breadcrumb span {
        color: #7E7E7E;
    }

    .mt-50 {
        margin-top: 50px;
    }

    .mb-50 {
        margin-bottom: 50px;
    }

    .detail-gallery {
        position: relative;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .zoom-icon {
        position: absolute;
        top: 30px;
        right: 30px;
        background-color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        z-index: 1;
    }

    .product-image-slider figure {
        margin: 0;
        overflow: hidden;
    }

    .product-image-slider img {
        width: 100%;
        height: auto;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .product-image-slider img:hover {
        transform: scale(1.05);
    }

    .slider-nav-thumbnails {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .slider-nav-thumbnails img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .slider-nav-thumbnails img:hover {
        border-color: #3BB77E;
        transform: translateY(-2px);
    }

    .slider-nav-thumbnails img.active-thumb {
        border-color: #3BB77E;
        transform: scale(1.05);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .detail-info {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .title-detail {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #253D4E;
    }

    .product-detail-rating {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .pro-details-brand {
        font-size: 14px;
    }

    .pro-details-brand a {
        color: #3BB77E;
        text-decoration: none;
    }

    .product-rate {
        background-color: #FFE0E0;
        height: 15px;
        width: 80px;
        border-radius: 10px;
    }

    .product-rating {
        background-color: #FDC040;
        height: 100%;
        border-radius: 10px;
    }

    .product-price-cover {
        margin: 30px 0;
    }

    .product-price {
        display: flex;
        align-items: center;
    }

    .text-brand {
        font-size: 32px;
        font-weight: 700;
        color: #3BB77E;
    }

    .old-price {
        color: #7E7E7E;
        text-decoration: line-through;
        margin-left: 15px;
    }

    .save-price {
        background-color: #FFE0E0;
        color: #FF5B5B;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 14px;
    }

    .short-desc {
        color: #7E7E7E;
        line-height: 1.6;
    }

    .detail-extralink {
        display: flex;
        gap: 20px;
        margin: 30px 0;
    }

    .detail-qty {
        display: flex;
        align-items: center;
        border: 1px solid #E5E5E5;
        border-radius: 5px;
        padding: 5px 15px;
    }

    .qty-val {
        padding: 0 15px;
        font-weight: 600;
    }

    .qty-down, .qty-up {
        color: #7E7E7E;
        text-decoration: none;
    }

    .button-add-to-cart {
        background-color: #3BB77E;
        color: #fff;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .button-add-to-cart:hover {
        background-color: #2a9d68;
    }

    .action-btn {
        width: 46px;
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #E5E5E5;
        border-radius: 5px;
        color: #253D4E;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background-color: #3BB77E;
        color: #fff;
        border-color: #3BB77E;
    }

    .product-meta {
        list-style: none;
        padding: 20px 0;
        margin: 0;
        border-top: 1px solid #E5E5E5;
    }

    .product-meta li {
        margin-bottom: 10px;
        color: #7E7E7E;
    }

    .product-meta a {
        color: #253D4E;
        text-decoration: none;
    }

    .in-stock {
        color: #3BB77E;
        font-weight: 600;
    }

    /* Zoom & Gallery Styles */
    .product-image-container {
        position: relative;
        width: 100%;
        height: 100%;
    }
    .product-image-container figure {
        margin: 0;
        width: 100%;
        height: 100%;
    }
    .product-image-container img {
        width: 100%;
        height: auto;
        display: block;
    }
    .zoom-lens {
        position: absolute;
        border: 1px solid #d4d4d4;
        width: 150px;
        height: 150px;
        background: rgba(255, 255, 255, 0.4);
        cursor: crosshair;
        display: none;
    }
    .zoom-result {
        position: absolute;
        top: 0;
        left: 105%;
        width: 500px;
        height: 500px;
        border: 1px solid #d4d4d4;
        background-repeat: no-repeat;
        background-color: #fff;
        display: none;
        z-index: 999;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
    @media (max-width: 1200px) {
        .zoom-result {
            display: none !important;
        }
    }

    /* Review Section Styles */
    .review-section {
        margin-top: 50px;
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .review-section h3 {
        font-size: 24px;
        color: #253D4E;
        margin-bottom: 20px;
    }

    .review-form {
        margin-bottom: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .star-rating {
        display: flex;
        gap: 5px;
        margin-bottom: 15px;
    }

    .star-rating input {
        display: none;
    }

    .star-rating label {
        cursor: pointer;
        font-size: 25px;
        color: #ddd;
    }

    .star-rating:hover label {
        color: #FDC040;
    }

    .star-rating input:checked ~ label {
        color: #FDC040;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: #FDC040;
    }

    .review-textarea {
        width: 100%;
        padding: 15px;
        border: 1px solid #e5e5e5;
        border-radius: 5px;
        margin-bottom: 15px;
        resize: vertical;
        min-height: 100px;
    }

    .review-submit-btn {
        background-color: #3BB77E;
        color: #fff;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .review-submit-btn:hover {
        background-color: #2a9d68;
    }

    .review-list {
        margin-top: 30px;
    }

    .review-item {
        padding: 20px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s ease;
    }

    .review-item:hover {
        background-color: #f8f9fa;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .review-user {
        font-weight: 600;
        color: #253D4E;
    }

    .review-date {
        font-size: 14px;
        color: #7E7E7E;
    }

    .review-rating {
        margin-bottom: 10px;
    }

    .review-rating .star {
        color: #FDC040;
        font-size: 18px;
    }

    .review-content {
        color: #4a4a4a;
        line-height: 1.6;
    }

    .no-reviews {
        text-align: center;
        padding: 30px;
        color: #7E7E7E;
    }

    .login-prompt {
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .login-prompt a {
        color: #3BB77E;
        text-decoration: none;
        font-weight: 600;
    }

    .login-prompt a:hover {
        text-decoration: underline;
    }

    /* Related Products Section Styles */
    .related-products {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        margin-top: 50px;
    }
    .related-title {
        font-size: 24px;
        font-weight: 700;
        color: #253D4E;
        margin-bottom: 20px;
        text-align: center;
    }
    .related-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }
    .product-card {
        width: 250px;
        border: 1px solid #eee;
        border-radius: 10px;
        overflow: hidden;
        background-color: #fff;
        transition: box-shadow 0.3s ease;
    }
    .product-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .product-card-image img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .product-card-details {
        padding: 15px;
    }
    .product-card-title {
        font-size: 18px;
        font-weight: 600;
        color: #253D4E;
        text-decoration: none;
        margin-bottom: 10px;
        display: block;
    }
    .product-card-description {
        font-size: 14px;
        color: #7E7E7E;
        margin-bottom: 10px;
    }
    .product-card-price {
        padding: 0 15px 15px;
    }
    .product-card-price .original-price {
        text-decoration: line-through;
        color: #7E7E7E;
        font-size: 14px;
    }
    .product-card-price .sale-price, .product-card-price .price {
        font-size: 18px;
        font-weight: 600;
        color: #3BB77E;
    }
    .product-card-actions {
        text-align: center;
        padding: 10px;
        border-top: 1px solid #eee;
    }
    .product-card-actions .button-primary {
        background-color: #3BB77E;
        color: #fff;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
    }
    .product-card-actions .button-primary:hover {
        background-color: #2a9d68;
    }
</style>
<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/" rel="nofollow">Home</a>
                <span>/</span> 
                <a href="/shop">Shop</a>
                <span>/</span> 
                Product Details
            </div>
        </div>
    </div>

    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-lg-9">
                    <div class="product-detail accordion-detail">
                        <div class="row mb-50">
                            <div class="col-md-6 col-sm-12 col-xs-12">
                                <div class="detail-gallery">
                                    <span class="zoom-icon"><i class="fi-rs-search"></i></span>
                                    <div class="product-image-slider">
                                        <div class="product-image-container">
                                            <figure class="border-radius-10">
                                                <img src="<%= product.image || 'https://via.placeholder.com/400' %>" 
                                                     alt="Product Image" 
                                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/400';">
                                            </figure>
                                        </div>
                                    </div>
                                    <% if (product.images && product.images.length > 0) { %>
                                        <div class="slider-nav-thumbnails">
                                            <% product.images.forEach(function(img) { %>
                                                <div>
                                                    <img src="<%= img %>" alt="thumbnail"
                                                         onerror="this.onerror=null; this.src='https://via.placeholder.com/80';">
                                                </div>
                                            <% }) %>
                                        </div>
                                    <% } %>
                                </div>
                            </div>

                            <div class="col-md-6 col-sm-12 col-xs-12">
                                <div class="detail-info">
                                    <h2 class="title-detail"><%= product.name %></h2>
                                    <div class="product-detail-rating">
                                        <div class="pro-details-brand">
                                            <span>Brand: <a href="/brand"><%= product.brand || 'Unknown' %></a></span>
                                        </div>
                                        <div class="product-rate-cover">
                                            <div class="product-rate">
                                                <div class="product-rating" style="width:90%"></div>
                                            </div>
                                            <span class="font-small ml-5 text-muted">(0 reviews)</span>
                                        </div>
                                    </div>

                                    <div class="clearfix product-price-cover">
                                        <div class="product-price primary-color float-left">
                                            <ins><span class="text-brand">RS :<%= product.price %></span></ins>
                                            <% if (product.regularPrice && product.regularPrice > product.price) { %>
                                                <ins><span class="old-price font-md ml-15">RS :<%= product.regularPrice %></span></ins>
                                            <% } %>
                                        </div>
                                    </div>

                                    <div class="short-desc mb-30">
                                        <p><%= product.description || 'No description available.' %></p>
                                    </div>

                                    <div class="detail-extralink">
                                        <div class="detail-qty border radius">
                                            <a href="#" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
                                            <span class="qty-val">1</span>
                                            <a href="#" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
                                        </div>
                                        <div class="product-extra-link2">
                                            <button type="button" class="button button-add-to-cart">Add to cart</button>
                                            <a aria-label="Add To Wishlist" class="action-btn hover-up" href="/wishlist">
                                                <i class="fi-rs-heart"></i>
                                            </a>
                                        </div>
                                    </div>

                                    <ul class="product-meta font-xs color-grey mt-50">
                                        <li>Availability: 
                                            <span class="in-stock text-success ml-5">
                                                <%= product.quantity > 0 ? 'In Stock' : 'Out of Stock' %>
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </div> 
                        </div> 
                    </div> 
                </div>
            </div>
        </div>
    </section>

    <section class="review-section container">
        <div class="row">
            <div class="col-lg-9">
                <h3>Customer Reviews</h3>
                
                <% if (user) { %>
                    <div class="review-form">
                        <h4>Write a Review</h4>
                        <form id="reviewForm">
                            <div class="star-rating">
                                <input type="radio" id="star5" name="rating" value="5" required>
                                <label for="star5">★</label>
                                <input type="radio" id="star4" name="rating" value="4">
                                <label for="star4">★</label>
                                <input type="radio" id="star3" name="rating" value="3">
                                <label for="star3">★</label>
                                <input type="radio" id="star2" name="rating" value="2">
                                <label for="star2">★</label>
                                <input type="radio" id="star1" name="rating" value="1">
                                <label for="star1">★</label>
                            </div>
                            <textarea 
                                class="review-textarea" 
                                name="review" 
                                placeholder="Share your thoughts about this product..." 
                                required
                            ></textarea>
                            <button type="submit" class="review-submit-btn">Submit Review</button>
                        </form>
                    </div>
                <% } else { %>
                    <div class="login-prompt">
                        <p>Please <a href="/login">login</a> to write a review</p>
                    </div>
                <% } %>

                <div class="review-list">
                    <% if (reviews && reviews.length > 0) { %>
                        <% reviews.forEach(function(review) { %>
                            <div class="review-item">
                                <div class="review-header">
                                    <span class="review-user">
                                        <%= (review.user && review.user.name) ? review.user.name : 'Deleted User' %>
                                    </span>
                                    <span class="review-date">
                                        <%= new Date(review.createdAt || new Date()).toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        }) %>
                                    </span>
                                </div>
                                <div class="review-rating">
                                    <% for(let i = 0; i < 5; i++) { %>
                                        <span class="star"><%= i < (review.rating || 0) ? '★' : '☆' %></span>
                                    <% } %>
                                </div>
                                <div class="review-content">
                                    <%= review.review || 'No comment provided' %>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="no-reviews">
                            <p>No reviews yet. Be the first to review this product!</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </section>

    <!-- Related Products Section -->
    <section class="related-products container">
        <h3 class="related-title">People also bought</h3>
        <% if (relatedProducts && relatedProducts.length > 0) { %>
            <div class="related-grid">
                <% relatedProducts.forEach(function(prod) { %>
                    <div class="product-card">
                        <a href="/product-details?id=<%= prod._id %>" class="product-card-image">
                            <% if (prod.productImages && prod.productImages.length > 0) { %>
                                <img src="<%= prod.productImages[0] %>" alt="<%= prod.productName %> image" onerror="this.onerror=null; this.src='https://via.placeholder.com/250x200';">
                            <% } else { %>
                                <img src="https://via.placeholder.com/250x200" alt="Placeholder image">
                            <% } %>
                        </a>
                        <div class="product-card-details">
                            <a href="/product-details?id=<%= prod._id %>" class="product-card-title"><%= prod.productName %></a>
                            <p class="product-card-description"><%= prod.description %></p>
                        </div>
                        <div class="product-card-price">
                            <% if (prod.salePrice && prod.salePrice < prod.regularPrice) { %>
                                <p class="original-price">$<%= prod.regularPrice.toLocaleString() %></p>
                                <p class="sale-price">$<%= prod.salePrice.toLocaleString() %></p>
                            <% } else { %>
                                <p class="price">$<%= prod.regularPrice.toLocaleString() %></p>
                            <% } %>
                        </div>
                        <div class="product-card-actions">
                            <button type="button" class="button-primary">Add to cart</button>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <p>No related products found.</p>
        <% } %>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('.slider-nav-thumbnails img');
    const mainImage = document.querySelector('.product-image-slider img');

    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            thumbnails.forEach(thumb => thumb.classList.remove('active-thumb'));
            this.classList.add('active-thumb');
            mainImage.src = this.src;
            mainImage.onerror = function() {
                this.onerror = null;
                this.src = 'https://via.placeholder.com/400';
            };
        });
    });

    const zoomIcon = document.querySelector('.zoom-icon');
    const productImage = document.querySelector('.product-image-slider');
    
    if (zoomIcon && productImage) {
        zoomIcon.addEventListener('click', function() {
            productImage.classList.toggle('zoomed');
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.product-image-container');
    const mainImage = document.querySelector('.product-image-slider img');
    
    if (!container || !mainImage) return;

    const lens = document.createElement('div');
    lens.className = 'zoom-lens';
    const zoomResult = document.createElement('div');
    zoomResult.className = 'zoom-result';
    
    container.style.position = 'relative';
    container.appendChild(lens);
    container.appendChild(zoomResult);

    function getZoomRatio() {
        return zoomResult.offsetWidth / lens.offsetWidth;
    }

    function moveLens(e) {
        e.preventDefault();
        const pos = getCursorPos(e);
        let x = pos.x - lens.offsetWidth / 2;
        let y = pos.y - lens.offsetHeight / 2;

        if (x > mainImage.width - lens.offsetWidth) x = mainImage.width - lens.offsetWidth;
        if (x < 0) x = 0;
        if (y > mainImage.height - lens.offsetHeight) y = mainImage.height - lens.offsetHeight;
        if (y < 0) y = 0;

        lens.style.left = x + "px";
        lens.style.top = y + "px";

        const ratio = getZoomRatio();
        zoomResult.style.backgroundImage = `url('${mainImage.src}')`;
        zoomResult.style.backgroundSize = (mainImage.width * ratio) + "px " + (mainImage.height * ratio) + "px";
        zoomResult.style.backgroundPosition = "-" + (x * ratio) + "px -" + (y * ratio) + "px";
    }

    function getCursorPos(e) {
        const rect = mainImage.getBoundingClientRect();
        return {
            x: e.pageX - rect.left - window.pageXOffset,
            y: e.pageY - rect.top - window.pageYOffset
        };
    }

    container.addEventListener('mouseenter', function(e) {
        lens.style.display = 'block';
        zoomResult.style.display = 'block';
        moveLens(e);
    });

    container.addEventListener('mouseleave', function() {
        lens.style.display = 'none';
        zoomResult.style.display = 'none';
    });

    container.addEventListener('mousemove', moveLens);
    
    const thumbnails = document.querySelectorAll('.slider-nav-thumbnails img');
    thumbnails.forEach(thumb => {
        thumb.addEventListener('click', function() {
            setTimeout(() => {
                zoomResult.style.backgroundImage = `url('${mainImage.src}')`;
            }, 100);
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const rating = formData.get('rating');
            const review = formData.get('review');
            
            if (!rating) {
                alert('Please select a rating');
                return;
            }

            try {
                const response = await fetch('/submit-review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId: '<%= product.stockCode %>',
                        rating: parseInt(rating),
                        review: review
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Review submitted successfully!');
                    location.reload();
                } else {
                    alert(data.message || 'Error submitting review');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting your review. Please try again.');
            }
        });
    }

    // Star rating interaction enhancement
    const starLabels = document.querySelectorAll('.star-rating label');
    starLabels.forEach(label => {
        label.addEventListener('mouseover', function() {
            const rating = this.previousElementSibling.value;
            highlightStars(rating);
        });
    });

    const starContainer = document.querySelector('.star-rating');
    if (starContainer) {
        starContainer.addEventListener('mouseleave', function() {
            const checkedInput = this.querySelector('input:checked');
            const rating = checkedInput ? checkedInput.value : 0;
            highlightStars(rating);
        });
    }

    function highlightStars(rating) {
        starLabels.forEach((label, index) => {
            label.style.color = index < rating ? '#FDC040' : '#ddd';
        });
    }
});
</script>
<%- include("../../views/partials/user/footer") %>
